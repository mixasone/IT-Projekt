{% extends 'base.html' %}

{% block content %}
  <!-- Title -->
  <div class="card card-body p-2">
    <h4 class="card-text text-center">
      <span id="prev">
        <button type="button" id="prevButton" style="background-color:transparent; border-color:transparent;">
          <i class="fas fa-angle-left"></i>
        </button>
      </span>
      <span id="title"></span>
      <span id="next">
        <button type="button" id="nextButton" style="background-color:transparent; border-color:transparent;">
          <i class="fas fa-angle-right"></i>
        </button>
      </span>
    </h4>
    <p id="userInfo" class="lead text-center p-0 m-0">User</p>
  </div>
  <!-- Chart -->
  <div class="card my-2">
    <div class="card-img-top">
      <canvas id="chart" class="card-text m-0"></canvas>
    </div>
  </div>
  <!-- Statistics -->
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Statistische Daten</h5>
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Gesamtverbrauch</h5>
              <p class="card-text">{{ g.data['sum'] }} kWh</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Durchschnittsverbrauch</h5>
              <p class="card-text">{{ g.data['avg'] }} kWh</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Minimalverbrauch</h5>
              <p class="card-text">{{ g.data['min'] }} kWh</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Maximalverbrauch</h5>
              <p class="card-text">{{ g.data['max'] }} kWh</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Gesamtkosten</h5>
              <p class="card-text" id="cost">-,-- €</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Table -->
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Zählwerte</h5>
      <div class="card-text table-responsive">
        <table class="table table-striped table-sm table-hover text-center">
          <tr class="d-flex">
            <th class="col">{{ tbl_title }}</th>
            <th class="col">Lastgang [{{ unit }}]</th>
            <th class="col">Zählerstand [kWh]</th>
            <th class="col">Kosten [€]</th>
          </tr>
          {% for meter in g.data['meter_data'] %}
            <tr class="d-flex">
              {% if g.fmt == 'day' %}
                <td class="col">{{ meter.datetime|datetime('day') }}</td>
              {% elif g.fmt == 'month' %}
                <td class="col">{{ meter.datetime|datetime('month') }}</td>
              {% else %}
                <td class="col">{{ meter.datetime|datetime }}</td>
              {% endif %}
              <td class="col diff">{{ meter.diff }}</td>
              <td class="col">{{ meter.reading }}</td>
              <td class="col cost">-,--</td>
            </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block contentjs %}
  <script>
      document.getElementById('changePrice').onclick = calcPrice;

      function calcPrice() {
          let priceCollection = document.getElementsByClassName('cost');
          const diffCollection = document.getElementsByClassName('diff');
          const price = document.getElementById("priceInput").value / 100;
          const res = document.getElementById("resSelector").value;

          let priceSum = price * {{ g.data['sum'] }};
          document.getElementById('cost').innerText = `${priceSum.toFixed(2)} €`;

          for (let i = 0; i < priceCollection.length; i++) {
              let cost = 0.0;
              {% if g.fmt == 'day' %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 24;
              {% elif g.fmt == 'month' %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 12;
              {% else %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 60 * parseInt(res);
              {% endif %}

              priceCollection[i].innerHTML = cost.toFixed(3)
          }
      }

      calcPrice();
  </script>
{% endblock %}