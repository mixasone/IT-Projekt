{% extends 'base.html' %}

{% block content_main %}
  <!-- Title -->
  <div class="card card-body p-2">
    <h4 class="card-text text-center">
      {% if g.mode == 'day' or g.mode == 'month' %}
      <a href="{{ prev_url }}">
        <i class="fas fa-angle-left"></i>
      </a>
      {% endif %}
      <span id="title">{{ datetime }}</span>
      {% if g.mode == 'day' or g.mode == 'month' %}
      <a href="{{ next_url }}">
        <i class="fas fa-angle-right"></i>
      </a>
      {% endif %}
    </h4>
    <p id="userInfo" class="lead text-center p-0 m-0">{{ meter_id }}</p>
  </div>
  <!-- Chart -->
  <div class="card my-2">
    <div class="card-img-top">
      <canvas id="chart" class="card-text m-0"></canvas>
    </div>
  </div>
  <!-- Statistics -->
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Statistische Daten</h5>
      {% include 'statistics.html' %}
    </div>
  </div>
  <!-- Table -->
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Zählwerte</h5>
      <div class="card-text table-responsive">
        {% include 'table.html' %}
      </div>
    </div>
  </div>
{% endblock %}

{% block content_js %}
  <script>
      document.getElementById('meterReadingsSelector').onchange = meterReadingsSelectorChanged;
      // document.getElementById('priceInput').onchange = alert(1);

      /* Chart functions */
      function makeChart() {
          /**
           * Update the chart according to the current response data
           * **/
          moment.locale('de');    // Set Moment.js to german language
          setChartSettings();

          let requestData = {{ g.data['meter_data']|tojson }};
          window.meterData = {
              datetimes: [],
              loadDiffs: [],
              meterReadings: []
          };

          requestData.forEach(d => {
              window.meterData.datetimes.push(d.datetime);
              window.meterData.loadDiffs.push(d.diff);
              window.meterData.meterReadings.push(d.reading);
          });

          // x-Axis values and settings
          let formattedLabels = [];
          {% if g.mode == 'interval' or g.mode == 'month' %}
              window.meterData.datetimes.forEach(t => formattedLabels.push(moment(t).format("L")));
          {% elif g.mode == 'year' %}
              window.meterData.datetimes.forEach(t => formattedLabels.push(moment(t).format("MMMM")));
          {% else %}
              window.meterData.datetimes.forEach(t => formattedLabels.push(moment(t).format("LT")));
          {% endif %}
          window.chart.data.labels = formattedLabels;

          // y-Axis values and settings
          window.chart.data.datasets[0].data = window.meterData.loadDiffs;  // Add loadDiffs to chart
          if (document.getElementById('meterReadingsSelector').checked) {
              window.chart.data.datasets[1].data = window.meterData.meterReadings;  // Add meterReadings to chart
          }
          window.chart.update();
      }

      function setChartSettings() {
          /**
           * Setup chart with the settings stored in the chart_settings.js file
           * **/

          const ctx = document.getElementById("chart").getContext('2d');
          window.chart = new Chart(ctx, {
              type: "bar",
              data: {
                  datasets: [{
                      label: "Lastgang",
                      backgroundColor: "rgba(255, 128, 0, 0.2)",
                      borderColor: "rgb(255, 128, 0)",
                      borderWidth: 1,
                      yAxisID: "y-axis-load",
                  }]
              },
              options: {
                  scales: {
                      xAxes: [{
                          scaleLabel: {
                              display: true,
                              labelString: "Zeitpunkt",
                          },
                          gridLines: {
                              offsetGridLines: true
                          }
                      }],
                      yAxes: [{
                          type: "linear",
                          display: true,
                          position: "left",
                          id: "y-axis-load",
                          scaleLabel: {
                              display: true,
                              labelString: "Lastgang [{{ unit }}]",
                          },
                          ticks: {
                              beginAtZero: true
                          }
                      }, {
                          type: "linear",
                          display: false,
                          position: "right",
                          id: "y-axis-energy",
                          scaleLabel: {
                              display: true,
                              labelString: "Zählerstand [kWh]",
                          },
                          gridLines: {
                              drawOnChartArea: false,
                          }
                      }]
                  },
                  tooltips: {
                      mode: "index",
                      // Custom tooltip settings
                      callbacks: {
                          label: function (tooltipItem, data) {
                              if (tooltipItem.datasetIndex === 0) {
                                  return tooltipItem.yLabel + ' {{ unit }}';
                              } else {
                                  return tooltipItem.yLabel + " kWh";
                              }
                          },
                          footer: function (tooltipItem, data) {
                              let kwhPrice;
                              let load = tooltipItem[0].yLabel;
                              let price = document.getElementById("priceInput").value / 100;
                              const res = document.getElementById("resSelector").value;
                              // let price = 0.3;
                              // kwhPrice = calculatePrice(load, price);
                              {% if g.mode == 'interval' or g.mode == 'month' %}
                                  kwhPrice = load * price / 24;
                              {% elif g.fmt == 'year' %}
                                  kwhPrice = load * price / 12;
                              {% else %}
                                  kwhPrice = load * price / 60 * parseInt(res);
                              {% endif %}

                              return "Kosten: " + kwhPrice.toFixed(2) + ' €';
                          },
                      },
                      footerFontStyle: "normal"
                  }
              }
          });
      }

      function meterReadingsSelectorChanged() {
          /**
           * Add and remove the meter value line graph from the chart
           * **/

          if (this.checked) { // Add line graph
              if (window.chart.data.datasets.length === 1) {   // Add line graph if not already in chart
                  window.chart.data.datasets.push({
                      label: 'Zählerstand',
                      data: window.meterData.meterReadings,
                      backgroundColor: "rgba(255, 0, 0, 0.2)",
                      borderColor: "rgb(255, 0, 0)",
                      borderWidth: 1,
                      type: "line",
                      yAxisID: 'y-axis-energy'
                  });
                  window.chart.options.scales.yAxes[1].display = true;
              } else {
                  window.chart.data.datasets[1].data = window.meterData.meterReadings;  // Update line graph values if already in chart
              }
          } else if (window.chart.data.datasets.length === 2) {    // Remove line graph if already in chart
              window.chart.data.datasets.pop();
              window.chart.options.scales.yAxes[1].display = false;
          }

          window.chart.update();
      }

      /* Price functions */
      function calcPrice() {
          let priceCollection = document.getElementsByClassName('cost');
          const diffCollection = document.getElementsByClassName('diff');
          const price = document.getElementById("priceInput").value / 100;
          const res = document.getElementById("resSelector").value;

          let priceSum = price * {{ g.data['sum'] }};
          document.getElementById('cost').innerText = `${priceSum.toFixed(2)} €`;

          for (let i = 0; i < priceCollection.length; i++) {
              let cost = 0.0;
              {% if g.mode == 'interval' or g.mode == 'month' %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 24;
              {% elif g.mode == 'year' %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 12;
              {% else %}
                  cost = parseFloat(diffCollection[i].innerHTML) * price / 60 * parseInt(res);
              {% endif %}

              priceCollection[i].innerHTML = cost.toFixed(3)
          }
      }

      makeChart();
      calcPrice();
  </script>
{% endblock %}