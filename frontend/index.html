<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>LaViSch</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
        crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheet.css" />
</head>

<body>
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-dark p-0 shadow">
        <!-- Title -->
        <span class="navbar-brand pl-3">Lastgangsvisualisierungsschnitstelle</span>
        <!-- <span id="user-info" class="navbar-nav px-3"></span>     -->
        <!-- Menu button -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidebar" aria-controls="sidebarToggler"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </header>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-light sidebar" id="sidebar">
                <h5>Abfrageoptionen</h5>
                <!-- Menu items -->
                <form class="form-group">
                    <!-- User selection -->
                    <label for="user-selector" class="col-form-label-sm">Zählernummer</label>
                    <select id="user-selector" onchange="updateUser()" class="form-control form-control-sm">
                        <option value="default"></option>
                    </select>
                    <!-- Mode selection -->
                    <label for="mode-selector" class="col-form-label-sm">Modus</label>
                    <select onchange="modeChanged()" id="mode-selector" class="form-control form-control-sm form-control-dark">
                        <option value="day">Tagesansicht</option>
                        <option value="interval">Intervall</option>
                        <option value="month">Monat</option>
                        <option value="year">Jahr</option>
                    </select>
                    <!-- Date selections -->
                    <div id="day-options" class="mb-8">
                        <label for="date-selector" class="col-form-label-sm">Datum</label>
                        <input type="date" id="date-selector" class="form-control form-control-sm">
                        <!-- Resolution selection -->
                        <label for="resolution-selector" class="col-form-label-sm">Auslösung</label>
                        <select id="resolution-selector" class="form-control form-control-sm">
                            <option value="15">Viertelstunde</option>
                            <option value="60">Stunde</option>
                        </select>
                    </div>
                    <div id="interval-options" style="display: none">
                        <label for="first-date-selector">Start Datum</label>
                        <input type="date" id="first-date-selector" class="form-control form-control-sm">
                        <label for="last-date-selector" class="col-form-label-sm">End Datum</label>
                        <input type="date" id="last-date-selector" class="form-control form-control-sm">
                    </div>
                    <div id="month-options" style="display: none">
                        <label for="month-selector" class="col-form-label-sm">Monat</label>
                        <input type="month" id="month-selector" class="form-control form-control-sm">
                    </div>
                    <div id="year-options" style="display: none">
                        <label for="year-selector" class="col-form-label-sm">Jahr</label>
                        <select id="year-selector" class="form-control form-control-sm"></select>
                    </div>
                    <!-- Submit button -->
                    <button type="button" onclick="getData()" class="form-control form-control-sm btn btn-outline-primary btn-sm my-3">Abrufen</button>
                    <!-- Show meter value -->
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="energy-view">
                        <label class="custom-control-label " for="energy-view">Zählerstand anzeigen</label>
                    </div>
                    <!-- Set price per kWh -->
                    <div class="custom-control custom-range my-3">
                        <label for="money-select">Preis pro kWh: <span id="money-val">0.30</span>€</label>
                        <input type="range" id="money-select" oninput="priceChanged()" class="form-control-range form-control-sm"
                            min="10" max="50" value="30">
                    </div>
                </form>
                <hr>
                <!-- Statistics -->
                <div id="stat" style="display: none">
                    <h5 class="mb-3">Statistische Daten</h5>
                    <ul id="stat-data" class="list-unstyled"></ul>
                </div>
            </nav>

            <!-- Main -->
            <main class="col-md-2 ml-sm-auto mr-sm-auto col-lg-10 px-4">
                <!-- Title -->
                <div class="card card-body p-2">
                    <h4 class="card-text text-center">
                        <a><i class="fas fa-angle-left pr-4"></i></a>
                        <span id="title">Lastgang vom {...}</span>
                        <a><i class="fas fa-angle-right pl-4"></i></a>
                    </h4>
                </div>
                <!-- Chart -->
                <div class="card card-body">
                    <canvas id="myChart" class="card-text" width="900" height="380"></canvas>
                </div>
                <!-- Table -->
                <div class="card card-body">
                    <div id="data-table" class="card-text table-responsive"></div>
                </div>
            </main>
        </div>

        <!-- Scripts -->

        <script>
            let myChart;
            let state = 1; // 1 - day, 2 - custom, 3 - month, 4 - year
            let userList = [];

            window.onload = function () {
                // Chart initialization
                setupChart()
                loadUsers();
            };

            function setupChart() {
                let ctx = document.getElementById("myChart").getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: 'Lastgang',
                            backgroundColor: "rgba(255, 128, 0, 0.2)",
                            borderColor: "rgb(255, 128, 0)",
                            borderWidth: 1,
                            yAxisID: 'y-axis-load',
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                scaleLabel: {
							        display: true,
							        labelString: 'Zeitpunkt'
						        }
                            }],
                            yAxes: [{
                                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                                display: true,
                                position: 'left',
                                id: 'y-axis-load',
                                scaleLabel: {
							        display: true,
							        labelString: 'Last / kWh/h'
						        }
                            }, {
                                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                                display: true,
                                position: 'right',
                                id: 'y-axis-energy',
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Zählerstand / kWh'
                                },
                                gridLines: {
                                    drawOnChartArea: false, // only want the grid lines for one axis to show up
                                }
                            }]
                        }
                    }
                });
            }

            function getData() {
                var http = new XMLHttpRequest();

                http.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        updateView(JSON.parse(this.responseText));
                    } else if (this.readyState == 4 && this.status == 400) {
                        window.alert("Fehler!");
                    }
                };

                let arguments = "u=" + document.getElementById("user-selector").value;

                // Generate query
                switch (state) {
                    case 1: // Day query
                        arguments += "&mode=" + document.getElementById("mode-selector").value +
                            "&d=" + document.getElementById("date-selector").value + // "2018-09-10" +
                            "&r=" + document.getElementById("resolution-selector").value;
                        break;
                    case 2: // Interval query
                        arguments += "&mode=" + document.getElementById("mode-selector").value +
                            "&sd=" + document.getElementById("first-date-selector").value +
                            "&ed=" + document.getElementById("last-date-selector").value;
                        break;
                    case 3:
                        arguments += "&mode=" + document.getElementById("mode-selector").value +
                            "&m=" + document.getElementById("month-selector").value;
                        break;
                    case 4:
                        arguments += "&mode=" + document.getElementById("mode-selector").value +
                            "&y=" + document.getElementById("year-selector").value;
                        break;
                }

                http.open("GET", "http://localhost:5000/data?" + arguments, true);
                http.send();
            }

            // Update and plot chart
            function updateView(response) {
                // Array for storing month names
                let months = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September",
                    "Oktober",
                    "November", "Dezember"
                ];
                // Update header
                switch (state) {
                    case 1:
                        let date = new Date(document.getElementById("date-selector").value);
                        document.getElementById("title").innerText = "Lastgang vom " + date.getDate() + ". " + months[
                                date.getMonth()] +
                            " " + date.getFullYear();
                        break;
                    case 2:
                        let firstDate = new Date(document.getElementById("first-date-selector").value);
                        let lastDate = new Date(document.getElementById("last-date-selector").value);
                        document.getElementById("title").innerText = "Lastgang vom " + firstDate.getDate() + ". " +
                            months[
                                firstDate.getMonth()] + " " + firstDate.getFullYear() + " - " + lastDate.getDate() +
                            ". " +
                            months[lastDate.getMonth()] + " " + lastDate.getFullYear();
                        break;
                    case 3:
                        let month = new Date(document.getElementById("month-selector").value);
                        document.getElementById("title").innerText = "Lastgang vom " + months[month.getMonth()] + " " +
                            month.getFullYear();
                        break;
                    case 4:
                        let year = new Date(document.getElementById("year-selector").value);
                        document.getElementById("title").innerText = "Lastgang vom Jahr " + year.getFullYear();
                        break;
                }

                // Update chart
                myChart.data.labels = response['dates'];
                myChart.data.datasets[0].data = response['diff'];
                if (document.getElementById("energy-view").checked === true) {
                    if (myChart.data.datasets.length === 1) {
                        myChart.data.datasets.push({
                            label: 'Zählerstand',
                            data: response['energy'],
                            backgroundColor: "rgba(0, 0, 255, 0.2)",
                            borderColor: "rgb(0, 0, 255)",
                            borderWidth: 1,
                            type: "line",
                            yAxisID: 'y-axis-energy',
                        })
                    } else {
                        myChart.data.datasets[1].data = response['energy'];
                    }
                } else if (myChart.data.datasets.length === 2) {
                    myChart.data.datasets.pop();
                }
                myChart.update();

                let price = document.getElementById("money-select").value / 100;
                
                // Update table
                let tableData =
                    "<table class=\"table table-striped table-sm\"><tr><th>Zeitpunkt</th><th>Lastgang / kW </th><th>Zählerstand / kWh </th><th>Kosten / € </th></tr>";
                for (let i in response['dates']) {
                    tableData += "<tr><td>" + response['dates'][i] + "</td><td>" + 
                    formatNumber(response['diff'][i]) + "</td><td>" +
                    formatNumber(response['energy'][i]) + "</td><td>" + 
                    calculatePrice(response['diff'][i], price) + "</td></tr>";
                }
                tableData += "</table>";
                document.getElementById("data-table").innerHTML = tableData;

                // Update statistics
                document.getElementById("stat").style.display = "block";
                document.getElementById("stat-data").innerHTML = "<li class=\"mb-3\"><h6>Durchschnittsverbrauch</h6>" +
                    response['avg'] +
                    " kWh</li>";
                document.getElementById("stat-data").innerHTML += "<li class=\"mb-3\"><h6>Maximalverbrauch</h6>" +
                    response['max'] +
                    " kWh</li>";
                document.getElementById("stat-data").innerHTML += "<li class=\"mb-3\"><h6>Minimalverbrauch</h6>" +
                    response['min'] +
                    " kWh</li>";
                document.getElementById("stat-data").innerHTML += "<li class=\"mb-3\"><h6>Gesamtverbrauch</h6>" +
                    response['sum'] +
                    " kWh</li>";
                document.getElementById("stat-data").innerHTML += "<li class=\"mb-3\"><h6>Gesamtkosten</h6>" +
                    (response['sum'] * price).toFixed(2) +
                    " €</li>";
            }

            // Adjust UI depending on selected mode
            function modeChanged() {
                const modeSelector = document.getElementById('mode-selector');

                if (modeSelector.value === "day") {
                    document.getElementById("day-options").style.display = "block";
                    document.getElementById("interval-options").style.display = "none";
                    document.getElementById("month-options").style.display = "none";
                    document.getElementById("year-options").style.display = "none";
                    state = 1; // Set state to day
                } else if (modeSelector.value === "interval") {
                    document.getElementById("day-options").style.display = "none";
                    document.getElementById("interval-options").style.display = "block";
                    document.getElementById("month-options").style.display = "none";
                    document.getElementById("year-options").style.display = "none";
                    state = 2; // Set state to custom
                } else if (modeSelector.value === "month") {
                    document.getElementById("day-options").style.display = "none";
                    document.getElementById("interval-options").style.display = "none";
                    document.getElementById("month-options").style.display = "block";
                    document.getElementById("year-options").style.display = "none";
                    state = 3; // Set state to month
                } else {
                    document.getElementById("day-options").style.display = "none";
                    document.getElementById("interval-options").style.display = "none";
                    document.getElementById("month-options").style.display = "none";
                    document.getElementById("year-options").style.display = "block";
                    state = 4; // Set state to year
                }
            }

            function formatNumber(number) {
                return Number.parseFloat(number).toFixed(2);
            }

            function priceChanged() {
                let price = document.getElementById("money-select").value / 100;
                document.getElementById("money-val").innerText = price.toFixed(2);
                console.log(price);
            }

            function calculatePrice(load, price) {
                let money;

                switch (state) {
                    case 1:
                        money = load * price / 60 * document.getElementById("resolution-selector").value
                        break;
                        case 2:
                        money = load * price / 24
                        break;
                        case 3:
                        money = load * price / 24
                        break;
                        case 4:
                        money = load * price / 60 * document.getElementById("resolution-selector").value
                        break;
                }

                return money.toFixed(3)
            }

            function loadUsers() {
                let http = new XMLHttpRequest();
                http.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        let response = JSON.parse(this.responseText);
                        response['users'].forEach(u => userList.push(u));
                        let userSelector = document.getElementById("user-selector");
                        userList.forEach(u =>
                            userSelector.innerHTML += "<option value=\"" + u["number"] + "\">" + u["number"] +
                            "</option>"
                        )
                    }
                };

                http.open("GET", "http://localhost:5000/boot", true);
                http.send();
            }

            function updateUser() {
                let meterNumber = document.getElementById("user-selector").value;
                if (meterNumber === "default") { // Do nothing if no user is selected
                    document.getElementById("user-info").innerHTML = "";
                    return;
                }
                let user = null;
                userList.forEach(u => {
                    if (u["number"] === meterNumber) {
                        user = u;
                    }
                });
                // document.getElementById("user-info").innerHTML = user["firstname"] + " " + user["lastname"] + " - " + user["city"] + " (" + user["zipcode"] + ")";

                let http = new XMLHttpRequest();
                http.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        let response = JSON.parse(this.responseText);
                        let maxDate = response['max_date'];
                        let minDate = response['min_date'];
                        console.log(maxDate.match(/(\d\d\d\d)(?=-)/g));
                        document.getElementById('date-selector').max = maxDate;
                        document.getElementById('date-selector').min = minDate;
                        document.getElementById('first-date-selector').max = maxDate;
                        document.getElementById('first-date-selector').min = minDate;
                        document.getElementById('last-date-selector').max = maxDate;
                        document.getElementById('last-date-selector').min = minDate;
                        document.getElementById('month-selector').max = maxDate.match(/(\d+-\d+)(?=-)/g);
                        document.getElementById('month-selector').min = minDate.match(/(\d+-\d+)(?=-)/g);
                        document.getElementById('year-selector').innerHTML = "<option value=\"" +
                            maxDate.match(/(\d\d\d\d)(?=-)/g) + "\">" + maxDate.match(/(\d\d\d\d)(?=-)/g) +
                            "</option>";
                    }
                };

                http.open("GET", "http://localhost:5000/users?u=" + meterNumber, true);
                http.send();
            }
        </script>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>
</body>

</html>